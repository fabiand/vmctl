#!/bin/sh

set -x

VMNAME=$1
INSTANCENAME=$VMNAME-$HOSTNAME

KUBECTL=$(ls -1 kubectl* || which kubectl)
VIRTCTL=$(ls -1 virtctl* || which virtctl)

trap "$KUBECTL delete --grace-period=0 vm $INSTANCENAME" EXIT

cat > vmToPodAffinity <<EOF
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: guest
                operator: In
                values:
                - $VMNAME
            topologyKey: 'kubernetes.io/hostname'
EOF

# Create a copy of the VM with generate name
$KUBECTL get ovm $VMNAME -o yaml \
  | sed "/^  name:/ s/name:.*/name: $INSTANCENAME/" \
  | sed "s/running:.*/running: true/" \
  | sed "/^    spec:/ r vmToPodAffinity" \
  | sed "/status:/,$ d" \
  | tee /dev/stderr \
  | $KUBECTL apply -f -

$KUBECTL get -o yaml ovm $INSTANCENAME

sleep inf
